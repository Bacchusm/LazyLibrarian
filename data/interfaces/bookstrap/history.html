<%inherit file="base.html"/>
<%!
    import lazylibrarian
%>
<%def name="headerIncludes()">
    <div id="subhead_container">
        <div id="subhead_menu">
            <a href="clearhistory?status=all" class="button btn btn-sm btn-primary">Clear All History</a>
            <a href="clearhistory?status=Processed" class="button btn btn-sm btn-primary">Clear Processed</a>
            <a href="clearhistory?status=Snatched" class="button btn btn-sm btn-primary">Clear Snatched</a>
            <a href="clearhistory?status=Failed" class="button btn btn-sm btn-primary">Clear Failed</a>
            <button class="button btn btn-sm btn-primary" type="button" value="showdownloads" id="showdownloads"> Download Count</button>
        </div>
    </div>
</%def>

<%def name="body()">
    <h1>${title}</h1>
    <div class="table-responsive">
        %if lazylibrarian.CONFIG['TOGGLES'] == True:
        Toggle: <a class="toggle-vis" data-column="0">Title</a> - <a class="toggle-vis" data-column="1">Type</a> - <a class="toggle-vis" data-column="2">ID</a> - <a class="toggle-vis" data-column="3">Provider</a> - <a class="toggle-vis" data-column="4">Date</a> - <a class="toggle-vis" data-column="5">Size</a> - <a class="toggle-vis" data-column="6">Status</a>
        <p>&nbsp;</p>
        %endif
        <table class="display table table-striped table-hover table-bordered" id="book_table">
            <thead>
                <tr>
                    <th class="filename">Title</th>
                    <th class="type">Type</th>
                    <th class="bookid">ID</th>
                    <th class="provider">Provider</th>
                    <th class="dateadded">Date</th>
                    <th class="size text-right">Size</th>
                    <th class="status text-center">Status</th>
                    <th class="hidden">percent</th>
                </tr>
            </thead>

</table>
</div>

</%def>
<%def name="headIncludes()">
</%def>
<%def name="javascriptIncludes()">
  <script type="text/javascript">

    $(document).ready(function()
    {

        $('#showdownloads').on('click', function(e) {
            $.get('showdownloads', function(data) {
                bootbox.dialog({
                    title: 'Successful Downloads',
                    message: '<pre>'+data+'</pre>',
                    buttons: {
                        primary: {
                            label: "Close",
                            className: 'btn-primary'
                        },
                        prompt: {
                            label: "Clear Counters",
                            className: 'btn-primary',
                            callback: function(result){ $.get("cleardownloads", function(e) {}); }
                        }
                    }
                });
            });
        });

        var table = $('#book_table').DataTable(
            {
                "responsive": true,
                "bAutoWidth": false,
                "stateSave": true,
                "order": [[ 4, 'desc' ]],
                "columnDefs":[
                    { targets: [1], 'render': function(data, type, row) {
                        var ftype = row[1]
                        if ( ftype == 'None' ) {ftype = 'eBook'}
                        if ( ftype.match(/^[0-9.-]+$/) != null ) {ftype = 'Magazine'}
                        return ftype;} },
                    { targets: [6], 'render': function(data, type, row) {
                        if ( row[9] == 0 ) { bar = data }
                        else {
                            if ( row[9] <= 25 ) { css = 'danger' }
                            else if ( row[9] <= 50 ) { css = 'warning' }
                            else if ( row[9] <= 75 ) { css = 'info' }
                            else { css = 'success' };
                            bar = '<div class="progress center-block" style="width: 150px;"><div class="progress-bar-' +
                            css + ' progress-bar progress-bar-striped" role="progressbar aria-valuenow="' + row[9] +
                            '" aria-valuemin="0" aria-valuemax="100" style="width: ' + row[9] +
                            '%;"><span class="sr-only">' + row[9] +
                            '% Complete</span><span class="progressbar-front-text">' + row[9] + '%</span></div></div>'
                            };
                        return bar;} },
                ],
                "oLanguage": {
                    "sSearch": "Filter: ",
                    "sLengthMenu":"Show _MENU_ rows per page",
                    "sEmptyTable": "No history found",
                    "sInfo":"Showing _START_ to _END_ of _TOTAL_ rows",
                    "sInfoEmpty":"Showing 0 to 0 of 0 rows",
                    "sInfoFiltered":"(filtered from _MAX_ total rows)"},
                "bServerSide": true,
                "sAjaxSource": 'getHistory',
                "bFilter": true,
                "sPaginationType": "full_numbers",
                "aLengthMenu": [[5, 10, 15, 25, 50, 100, -1], [5, 10, 15, 25, 50, 100, "All"]],
                "iDisplayLength": ${lazylibrarian.CONFIG['DISPLAYLENGTH']},
                "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                    $('td', nRow).eq(4).addClass('text-center');
                    $('td', nRow).eq(7).addClass('hidden');
                    return nRow;
                },
                "aaSorting": [[4, 'desc']],
            });
            $('.dataTables_filter input').attr("placeholder", "Results filter");
            $('a.toggle-vis').click(function (e) {
                e.preventDefault();
                var column = table.column( $(this).attr('data-column') );
                column.visible( ! column.visible() );
            } );
    });
    // to redraw the progress bars...
    // table.rows().invalidate().draw( false );
    // or table.cell( this ).invalidate().draw();
    var timer;
    refreshrate = 5000;
    if(timer)
          {
            clearInterval(timer);
        }
        if(refreshrate != 0)
        {
            timer = setInterval("$('#book_table').rows().invalidate().draw( false )", refreshrate);
        }
  </script>

</%def>
